name: Update Leaderboard

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  leaderboard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure README exists
        run: |
          if [ ! -f README.md ]; then
            echo "# Project Title" > README.md
          fi

      - name: Generate leaderboard
        run: |
          # Collect contributions: author,difficulty
          git ls-files | grep -E '^[0-9]+[A-Z]_[0-9]+\.py$' | while read file; do
            author=$(git log --pretty=format:"%an" -- $file | tail -1)
            difficulty=$(echo "$file" | sed -E 's/.*_([0-9]+)\.py/\1/')
            echo "$author,$difficulty"
          done > contributions.csv

          # Get all difficulties
          diffs=$(cut -d',' -f2 contributions.csv | sort -n -u)

          # Create markdown table header
          echo -n "| User " > leaderboard.md
          for d in $diffs; do
            echo -n "| $d " >> leaderboard.md
          done
          echo "| Total |" >> leaderboard.md

          # Separator
          echo -n "|------" >> leaderboard.md
          for d in $diffs; do
            echo -n "|------" >> leaderboard.md
          done
          echo "|-------|" >> leaderboard.md

          # Table rows
          for user in $(cut -d',' -f1 contributions.csv | sort -u); do
            line="| $user "
            total=0
            for d in $diffs; do
              count=$(grep "^$user,$d$" contributions.csv | wc -l)
              line="$line| $count "
              total=$((total + count))
            done
            line="$line| $total |"
            echo "$line" >> leaderboard.md
          done

      - name: Insert leaderboard into README
        run: |
          awk '/<!-- LEADERBOARD:START -->/{flag=1;print;system("cat leaderboard.md");next}
/<!-- LEADERBOARD:END -->/{flag=0} !flag' README.md > README_new.md
          mv README_new.md README.md

      - name: Commit leaderboard
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Update leaderboard [skip ci]" || echo "No changes"
          git push
